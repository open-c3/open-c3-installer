#!/usr/bin/env bash
set -euo pipefail

cd "$(cd "$(dirname "$0")" && pwd)"

# ========= å‡½æ•°å®šä¹‰ =========
red()   { echo -e "\033[31m$1\033[0m"; }
green() { echo -e "\033[32m$1\033[0m"; }

# ========= ç¯å¢ƒæ£€æŸ¥ =========
if ! command -v docker &>/dev/null; then
    red "âŒ è¯·å…ˆå®‰è£… Docker åå†æ‰§è¡Œæœ¬è„šæœ¬ã€‚"
    exit 1
fi

# ========= æ£€æŸ¥é•œåƒæ–‡ä»¶ç›®å½• =========
if [ ! -d "./images" ]; then
    red "âŒ æœªæ‰¾åˆ° images ç›®å½•ã€‚è¯·ç¡®ä¿å½“å‰ç›®å½•ä¸‹æœ‰ images/ ç›®å½•å¹¶åŒ…å« .tar é•œåƒæ–‡ä»¶ã€‚"
    exit 1
fi

IMAGE_LIST="open-c3/Installer/scripts/quick_start-image.list"
if [ ! -f "$IMAGE_LIST" ]; then
    red "âŒ æœªæ‰¾åˆ°é•œåƒåˆ—è¡¨æ–‡ä»¶ï¼š$IMAGE_LIST"
    exit 1
fi

# ========= åŠ è½½é•œåƒ =========
green "ğŸ“¦ å¼€å§‹ä»æœ¬åœ°åŠ è½½ Docker é•œåƒ..."
while IFS= read -r image; do
    [[ -z "$image" || "$image" == \#* ]] && continue
    tar_file="images/$(echo "$image" | tr '/:' '_').tar"
    if [ -f "$tar_file" ]; then
        green "ğŸ“¥ åŠ è½½é•œåƒï¼š$image"
        docker load -i "$tar_file"
    else
        red "âš ï¸ ç¼ºå°‘é•œåƒæ–‡ä»¶ï¼š$tar_file"
        exit 1
    fi
done < "$IMAGE_LIST"
green "âœ… æ‰€æœ‰é•œåƒå·²åŠ è½½å®Œæˆã€‚"

# ========= æ‹·è´ä»£ç åˆ°ç›®æ ‡è·¯å¾„ =========
TARGET_DIR="/data/open-c3"

if [ -d "$TARGET_DIR" ]; then
    red "âŒ ç›®å½•å·²å­˜åœ¨ï¼š$TARGET_DIR"
    red "ä¸ºé˜²æ­¢é‡å¤å®‰è£…ï¼Œè¯·å…ˆæ‰‹åŠ¨åˆ é™¤è¯¥ç›®å½•åå†æ‰§è¡Œã€‚"
    exit 1
fi

green "ğŸ“ æ­£åœ¨å¤åˆ¶ open-c3 åˆ° $TARGET_DIR ..."
mkdir -p "$(dirname "$TARGET_DIR")"
cp -r ./open-c3 "$TARGET_DIR"
green "âœ… Open-C3 ä»£ç å¤åˆ¶å®Œæˆã€‚"

# ========= æ‰§è¡Œå®‰è£… =========
cd "$TARGET_DIR"
green "ğŸš€ å¼€å§‹å®‰è£… Open-C3ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰..."
OPENC3VERSION=v2.6.1 bash Installer/scripts/single.sh install 10.10.10.10

